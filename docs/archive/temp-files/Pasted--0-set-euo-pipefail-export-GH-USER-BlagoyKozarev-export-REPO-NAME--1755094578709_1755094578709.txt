# ====== 0) –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ======
set -euo pipefail

export GH_USER="BlagoyKozarev"
export REPO_NAME="VeganMapAI"
export MAIN_BRANCH="main"
export CLEAN_BRANCH="clean/$(date +%Y%m%d)"
export NEW_TOKEN="__NEW_GH_PAT__"   # <-- –°–ú–ï–ù–ò –ú–ï

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á–µ —Å–º–µ –≤ git repo
git rev-parse --is-inside-work-tree >/dev/null

# ====== 1) –ù–æ—Ä–º–∞–ª–∏–∑–∏—Ä–∞–π remote (–±–µ–∑ —Ç–æ–∫–µ–Ω–∏ –≤ URL) ======
git remote set-url origin "https://github.com/${GH_USER}/${REPO_NAME}.git"

# –ü–æ –∂–µ–ª–∞–Ω–∏–µ: –≤—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ push, –±–µ–∑ –¥–∞ –≥–æ –∑–∞–ø–∏—Å–≤–∞–º–µ –≤ remote URL:
git config --local credential.helper store
echo "https://${NEW_TOKEN}:x-oauth-basic@github.com" > ~/.git-credentials
chmod 600 ~/.git-credentials

# ====== 2) –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π git-filter-repo (–∞–∫–æ –ª–∏–ø—Å–≤–∞) ======
if ! command -v git-filter-repo >/dev/null 2>&1; then
  python3 -m pip install --user git-filter-repo
  export PATH="$HOME/.local/bin:$PATH"
fi

# ====== 3) –ò–≥–Ω–æ—Ä–∏—Ä–∞–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ –∑–∞ –≤ –±—ä–¥–µ—â–µ ======
cat >> .gitignore <<'EOF'
# Secrets / keys / env
*.key
*.p12
*.pem
*.cer
*.crt
*.der
*.jks
*.keystore
*.p8
*.pfx
*.json
.env
.env.*
attached_assets/
*.bak
*.backup
*.old
# Replit artifacts (–∞–∫–æ —Å—ä–¥—ä—Ä–∂–∞—Ç —Å–µ–∫—Ä–µ—Ç–∏)
replit_secrets/* 
EOF

# –ü—Ä–µ–º–∞—Ö–Ω–∏ –≤–µ—á–µ —Ç—Ä–∞–∫–Ω–∞—Ç–∏ —Å–µ–∫—Ä–µ—Ç–∏ –æ—Ç index-–∞ (–Ω–µ –æ—Ç –¥–∏—Å–∫–∞)
git rm -r --cached --ignore-unmatch attached_assets || true
git rm --cached --ignore-unmatch *.json *.key *.p12 *.pem *.p8 *.pfx || true
git rm --cached --ignore-unmatch .env .env.* || true

git add -A
git commit -m "chore(security): add .gitignore and untrack secrets" || true

# ====== 4) –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞–π blob-–æ–≤–µ—Ç–µ, –±–ª–æ–∫–∏—Ä–∞–Ω–∏ –æ—Ç Push Protection (–ø–æ —Ç–≤–æ—è –ª–æ–≥) ======
cat > blobs.txt <<'EOF'
857b989b772b39270ff2463a1a0071cb579ec908
16fff1a56e32780a1f0c3a0412f6d3cdfff43ee4
1ccb3f191ee0c32cd093c389a07aaf3556b07d23
0ba997fcf86d32e2c9a969d1c8a290de3e466bc9
EOF

# (–ü–æ –∂–µ–ª–∞–Ω–∏–µ: –≤–∏–∂ –ø–æ –∫–æ–∏ –ø—ä—Ç–∏—â–∞ —Å–∞ –±–∏–ª–∏ —Ç–µ–∑–∏ blob-–æ–≤–µ)
git rev-list --objects --all | grep -F -f blobs.txt || true

# ====== 5) –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ —á–∏—Å—Ç–µ–Ω–µ –Ω–∞ —Å–µ–∫—Ä–µ—Ç–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞—Ä–≥–µ—Ç–∏—Ä–∞–Ω–æ) ======
# 5.1 –ü—Ä–µ–º–∞—Ö–Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ç–µ blob-–æ–≤–µ, –∑–∞—Å–µ—á–µ–Ω–∏ –æ—Ç GitHub
git filter-repo --force --strip-blobs-with-ids blobs.txt

# 5.2 –ü—Ä–µ–º–∞—Ö–Ω–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏/—Ñ–∞–π–ª–æ–≤–∏ –º–æ–¥–µ–ª–∏ –æ—Ç —Ü—è–ª–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è (–∞–∫–æ —Å–∞ —Å—ä–¥—ä—Ä–∂–∞–ª–∏ –∫–ª—é—á–æ–≤–µ)
git filter-repo --force \
  --path attached_assets --invert-paths \
  --path-glob '*.json' --invert-paths \
  --path-glob '.env' --invert-paths \
  --path-glob '.env.*' --invert-paths

# 5.3 –ó–∞–º–µ–Ω–∏ –æ—á–µ–≤–∏–¥–Ω–∏ —Ç–æ–∫–µ–Ω/–∫–ª—é—á –ø–∞—Ç—ä—Ä–Ω–∏ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ (–¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –º—Ä–µ–∂–∞ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç)
cat > replacements.txt <<'EOF'
regex:ghp_[A-Za-z0-9]+==>***REMOVED***
regex:(?s)-----BEGIN PRIVATE KEY-----.*?-----END PRIVATE KEY----->***REMOVED***
regex:(?i)"private_key"\s*:\s*".*?"==>"private_key":"***REMOVED***"
regex:(?i)"client_secret"\s*:\s*".*?"==>"client_secret":"***REMOVED***"
regex:(?i)"access_token"\s*:\s*".*?"==>"access_token":"***REMOVED***"
EOF

git filter-repo --force --replace-text replacements.txt

# ====== 6) –õ–æ–∫–∞–ª–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞, —á–µ –Ω—è–º–∞ —è–≤–Ω–∏ —Å–µ–∫—Ä–µ—Ç–∏ ======
# –ë—ä—Ä–∑–∏ –µ–≤—Ä–∏—Å—Ç–∏–∫–∏:
! git log -S "ghp_" --all || true
! git grep -I -n "BEGIN PRIVATE KEY" -- $(git ls-files) || true
! git grep -I -n "client_secret" -- $(git ls-files) || true
! git grep -I -n "access_token" -- $(git ls-files) || true

# ====== 7) –ó–∞—â–∏—Ç–∞ –∑–∞ –±—ä–¥–µ—â–∏ push-–æ–≤–µ (pre-push hook —Å—ä—Å —Å–∫–∞–Ω–∏—Ä–∞–Ω–µ) ======
mkdir -p .git/hooks
cat > .git/hooks/pre-push <<'EOF'
#!/usr/bin/env bash
set -e
# –õ–µ–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞ –æ—á–µ–≤–∏–¥–Ω–∏ —Å–µ–∫—Ä–µ—Ç–∏
if git diff --cached | grep -E 'ghp_[A-Za-z0-9]+' -q; then
  echo "‚ùå Detected token pattern ghp_... in staged changes. Aborting push."
  exit 1
fi
if git diff --cached | grep -E 'BEGIN PRIVATE KEY' -q; then
  echo "‚ùå Detected PRIVATE KEY in staged changes. Aborting push."
  exit 1
fi
exit 0
EOF
chmod +x .git/hooks/pre-push

# ====== 8) Push –∫—ä–º —á–∏—Å—Ç –∫–ª–æ–Ω (–ø—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ), –ø–æ—Å–ª–µ PR –∫—ä–º main ======
# (–¢–æ–≤–∞ –∏–∑–±—è–≥–≤–∞ –º–æ–º–µ–Ω—Ç–Ω–æ –±–ª–æ–∫–∏—Ä–∞–Ω–µ –æ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤—ä—Ä—Ö—É main –∏ –¥–∞–≤–∞ —à–∞–Ω—Å –∑–∞ –ø—Ä–µ–≥–ª–µ–¥)
git branch -f "${CLEAN_BRANCH}"
git push -u origin "HEAD:${CLEAN_BRANCH}" --force

echo "‚úÖ –ò–∑–ø—Ä–∞—Ç–∏—Ö —á–∏—Å—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –∫—ä–º: ${CLEAN_BRANCH}"
echo "üëâ –û—Ç–≤–æ—Ä–∏ PR ${CLEAN_BRANCH} ‚Üí ${MAIN_BRANCH} –≤ GitHub UI –∏ merge-–Ω–∏."

# ====== 9) (–ê–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞) –î–∏—Ä–µ–∫—Ç–µ–Ω push –∫—ä–º main (–∞–∫–æ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—à) ======
# –í–ù–ò–ú–ê–ù–ò–ï: –ú–æ–∂–µ –ø–∞–∫ –¥–∞ –∑–∞–¥–µ–π—Å—Ç–≤–∞ –∑–∞—â–∏—Ç–∏—Ç–µ, –∞–∫–æ –µ –æ—Å—Ç–∞–Ω–∞–ª–æ –Ω–µ—â–æ —Å–∫—Ä–∏—Ç–æ.
# –†–∞–∑–∫–æ–º–µ–Ω—Ç–∏—Ä–∞–π —Å–ª–µ–¥–Ω–∏—è —Ä–µ–¥ —Å–∞–º–æ –∞–∫–æ –∏—Å–∫–∞—à –¥–∏—Ä–µ–∫—Ç–Ω–æ:
# git push origin "HEAD:${MAIN_BRANCH}" --force-with-lease

# ====== 10) –§–∏–Ω–∞–ª–Ω–æ: –ø–æ—á–∏—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ ======
rm -f blobs.txt replacements.txt

echo "üéâ –ì–æ—Ç–æ–≤–æ. –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –ø—Ä–µ—á–∏—Å—Ç–µ–Ω–∞, —Å–µ–∫—Ä–µ—Ç–∏—Ç–µ –∏–≥–Ω–æ—Ä–∏—Ä–∞–Ω–∏ –∏ —á–∏—Å—Ç –∫–ª–æ–Ω –µ –∫–∞—á–µ–Ω."
